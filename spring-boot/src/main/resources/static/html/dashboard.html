<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="../css/dashboard.css">
    <script src="../js/chart-utils.js"></script>
</head>
<body>
    <div class="container">
        <nav id="main-nav"></nav>
        
        <h1>Daily Feeding Totals</h1>

        <div class="daily-summary-section">
            <h2>Daily Summary</h2>
            <div class="summary-date-selector">
                <label for="summaryDate">Select Date:</label>
                <input type="date" id="summaryDate" required>
            </div>
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-label">Pumping Total</div>
                    <div class="summary-value" id="pumpingTotal">0 ml</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Left Breast</div>
                    <div class="summary-value" id="leftBreastTotal">0 sec</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Right Breast</div>
                    <div class="summary-value" id="rightBreastTotal">0 sec</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Total Breast</div>
                    <div class="summary-value" id="breastTotal">0 sec</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Bottle Total</div>
                    <div class="summary-value" id="bottleTotal">0 ml</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Pumping vs Bottle</div>
                    <div class="summary-value" id="pumpingVsBottle">0 ml</div>
                </div>
                <div class="summary-card recent-feed-card">
                    <div class="summary-label">Last Feed</div>
                    <div class="summary-value" id="recentFeedTime">--:--</div>
                    <div class="summary-subvalue" id="recentFeedDetails">No feed recorded</div>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h2>Add New Entry</h2>
            <form id="entryForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" id="date" name="date" required>
                    </div>
                    <div class="form-group">
                        <label for="time">Time</label>
                        <input type="time" id="time" name="time" required>
                    </div>
                    <div class="form-group">
                        <label for="leftBreastAmount">Left Breast (minutes)</label>
                        <input type="number" id="leftBreastAmount" name="leftBreastAmount" min="0" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="rightBreastAmount">Right Breast (minutes)</label>
                        <input type="number" id="rightBreastAmount" name="rightBreastAmount" min="0" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="bottleAmount">Bottle (ml)</label>
                        <input type="number" id="bottleAmount" name="bottleAmount" min="0" value="0" required>
                    </div>
                </div>
                <div class="controls">
                    <button type="submit">Add Entry</button>
                    <button type="button" class="btn-secondary" onclick="loadDailyTotals()">Reload Graph</button>
                </div>
                <div id="successMessage" class="success-message">Entry added successfully!</div>
            </form>
        </div>

        <h2>Feeding Graph</h2>
        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading...</p>
            </div>
        </div>

        <div class="timeline-section">
            <h2>Daily Timeline</h2>
            <div class="timeline-date-selector">
                <input type="date" id="timelineDate" required>
            </div>
            <div id="timelineContainer" class="timeline-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading timeline...</p>
                </div>
            </div>
        </div>

        <div class="entries-section">
            <h2>All Entries</h2>
            <div class="entries-table-container">
                <table class="entries-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)"></th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Left Breast (min)</th>
                            <th>Right Breast (min)</th>
                            <th>Total Breast (min)</th>
                            <th>Bottle (ml)</th>
                        </tr>
                    </thead>
                    <tbody id="entriesTableBody">
                        <tr><td colspan="7" style="text-align: center; color: #999;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="entries-controls">
                <button type="button" class="btn-delete" id="deleteButton" onclick="deleteSelectedEntries()" disabled>Delete Selected</button>
                <span id="selectedCount" style="color: #666; margin-top: 5px;"></span>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let chart = null;
        let allEntries = [];

        // Set default date and time to now
        document.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            document.getElementById('date').valueAsDate = now;
            document.getElementById('time').value = now.toTimeString().substring(0, 5);
            document.getElementById('timelineDate').valueAsDate = now;
            document.getElementById('summaryDate').valueAsDate = now;
            loadDailyTotals();
            loadEntries();
            loadTimeline();
            loadTodaysSummary();
        });

        // Load summary when date changes
        document.getElementById('summaryDate').addEventListener('change', () => {
            loadTodaysSummary();
        });

        // Load timeline when date changes
        document.getElementById('timelineDate').addEventListener('change', loadTimeline);

        // Handle form submission
        document.getElementById('entryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                date: document.getElementById('date').value,
                time: document.getElementById('time').value,
                leftBreastAmount: parseInt(document.getElementById('leftBreastAmount').value),
                rightBreastAmount: parseInt(document.getElementById('rightBreastAmount').value),
                bottleAmount: parseInt(document.getElementById('bottleAmount').value)
            };

            try {
                const response = await fetch('/api/breastfeeding/entries', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Show success message
                const successMsg = document.getElementById('successMessage');
                successMsg.style.display = 'block';
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 3000);

                // Reset amount fields
                document.getElementById('leftBreastAmount').value = '0';
                document.getElementById('rightBreastAmount').value = '0';
                document.getElementById('bottleAmount').value = '0';

                // Reload the graph and entries table
                loadDailyTotals();
                loadEntries();
                loadTodaysSummary();
                loadTimeline();
            } catch (error) {
                alert(`Failed to add entry: ${error.message}`);
            }
        });

        // Fetch and display daily totals
        async function loadDailyTotals() {
            try {
                const response = await fetch('/api/breastfeeding/dailyTotals');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                displayDashboardChart(data);
            } catch (error) {
                displayError(`Failed to load data: ${error.message}`);
            }
        }

        function displayDashboardChart(totals) {
            chart = displayChart({
                containerId: 'content',
                data: totals,
                chartInstance: chart,
                emptyMessage: 'No data available',
                prepareLabels: (data) => data.map(t => new Date(t.date).toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric' 
                })),
                datasets: [
                    {
                        label: 'Breast (min)',
                        prepareData: (data) => data.map(t => t.breastTotal),
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)'
                    },
                    {
                        label: 'Bottle (ml)',
                        prepareData: (data) => data.map(t => t.bottleTotal),
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)'
                    }
                ]
            });
        }

        function displayError(message) {
            document.getElementById('content').innerHTML = `<div class="error">${message}</div>`;
        }

        // Load and display summary for selected date
        async function loadTodaysSummary() {
            const selectedDate = document.getElementById('summaryDate').value;
            
            try {
                const [breastfeedingResponse, pumpingResponse] = await Promise.all([
                    fetch(`/api/breastfeeding/entries?date=${selectedDate}`),
                    fetch(`/api/pumping/entries?date=${selectedDate}`)
                ]);

                let leftBreastTotal = 0;
                let rightBreastTotal = 0;
                let bottleTotal = 0;
                let pumpingTotal = 0;

                let recentFeedTime = '--:--';
                let recentFeedDetails = 'No feed recorded';

                if (breastfeedingResponse.ok) {
                    const breastfeedingEntries = await breastfeedingResponse.json();
                    leftBreastTotal = breastfeedingEntries.reduce((sum, e) => sum + (e.leftBreastAmount || 0), 0);
                    rightBreastTotal = breastfeedingEntries.reduce((sum, e) => sum + (e.rightBreastAmount || 0), 0);
                    bottleTotal = breastfeedingEntries.reduce((sum, e) => sum + (e.bottleAmount || 0), 0);

                    if (breastfeedingEntries.length > 0) {
                        const latestEntry = breastfeedingEntries.reduce((latest, current) =>
                            current.time.localeCompare(latest.time) > 0 ? current : latest
                        );
                        const breastTotalEntry = (latestEntry.leftBreastAmount || 0) + (latestEntry.rightBreastAmount || 0);
                        const bottleAmount = latestEntry.bottleAmount || 0;
                        const details = [];

                        if (breastTotalEntry > 0) {
                            details.push(`Breast: ${breastTotalEntry} min`);
                        }
                        if (bottleAmount > 0) {
                            details.push(`Bottle: ${bottleAmount} ml`);
                        }
                        if (details.length === 0) {
                            details.push('No amounts recorded');
                        }

                        recentFeedTime = latestEntry.time;
                        recentFeedDetails = details.join(' ‚Ä¢ ');
                    }
                }

                if (pumpingResponse.ok) {
                    const pumpingEntries = await pumpingResponse.json();
                    pumpingTotal = pumpingEntries.reduce((sum, e) => sum + (e.amount || 0), 0);
                }

                const breastTotal = leftBreastTotal + rightBreastTotal;
                const difference = pumpingTotal - bottleTotal;

                // Update display
                document.getElementById('pumpingTotal').textContent = `${pumpingTotal} ml`;
                document.getElementById('leftBreastTotal').textContent = `${leftBreastTotal} min`;
                document.getElementById('rightBreastTotal').textContent = `${rightBreastTotal} min`;
                document.getElementById('breastTotal').textContent = `${breastTotal} min`;
                document.getElementById('bottleTotal').textContent = `${bottleTotal} ml`;
                
                const diffElement = document.getElementById('pumpingVsBottle');
                diffElement.textContent = `${difference > 0 ? '+' : ''}${difference} ml`;
                
                if (difference > 0) {
                    diffElement.style.color = '#4CAF50';
                    diffElement.style.fontWeight = 'bold';
                } else if (difference < 0) {
                    diffElement.style.color = '#f44336';
                    diffElement.style.fontWeight = 'bold';
                } else {
                    diffElement.style.color = '#333';
                    diffElement.style.fontWeight = 'normal';
                }

                const recentFeedTimeElement = document.getElementById('recentFeedTime');
                const recentFeedDetailsElement = document.getElementById('recentFeedDetails');
                if (recentFeedTimeElement && recentFeedDetailsElement) {
                    recentFeedTimeElement.textContent = recentFeedTime;
                    recentFeedDetailsElement.textContent = recentFeedDetails;
                }
            } catch (error) {
                console.error('Failed to load summary:', error);
            }
        }

        // Load entries and display in table
        async function loadEntries() {
            try {
                const response = await fetch('/api/breastfeeding/entries?direction=DESC');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allEntries = await response.json();
                displayEntries();
            } catch (error) {
                document.getElementById('entriesTableBody').innerHTML = `<tr><td colspan="7" style="color: red;">Failed to load entries: ${error.message}</td></tr>`;
            }
        }

        function displayEntries() {
            const tbody = document.getElementById('entriesTableBody');
            
            if (allEntries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">No entries found</td></tr>';
                return;
            }

            tbody.innerHTML = allEntries.map(entry => `
                <tr>
                    <td><input type="checkbox" class="entry-checkbox" value="${entry.id}" onchange="updateDeleteButton()"></td>
                    <td>${new Date(entry.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                    <td>${entry.time}</td>
                    <td>${entry.leftBreastAmount}</td>
                    <td>${entry.rightBreastAmount}</td>
                    <td>${entry.leftBreastAmount + entry.rightBreastAmount}</td>
                    <td>${entry.bottleAmount}</td>
                </tr>
            `).join('');
        }

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.entry-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateDeleteButton();
        }

        function updateDeleteButton() {
            const selected = document.querySelectorAll('.entry-checkbox:checked').length;
            const deleteBtn = document.getElementById('deleteButton');
            const selectedCount = document.getElementById('selectedCount');
            
            deleteBtn.disabled = selected === 0;
            selectedCount.textContent = selected > 0 ? `${selected} selected` : '';
            
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const allCheckboxes = document.querySelectorAll('.entry-checkbox');
            selectAllCheckbox.checked = allCheckboxes.length > 0 && Array.from(allCheckboxes).every(cb => cb.checked);
        }

        async function deleteSelectedEntries() {
            const selected = Array.from(document.querySelectorAll('.entry-checkbox:checked')).map(cb => parseInt(cb.value));
            
            if (selected.length === 0) {
                alert('No entries selected');
                return;
            }

            if (!confirm(`Delete ${selected.length} entry(ies)?`)) {
                return;
            }

            try {
                const response = await fetch('/api/breastfeeding/entries/batch', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(selected)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Reload data
                loadEntries();
                loadDailyTotals();
                document.getElementById('selectAllCheckbox').checked = false;
            } catch (error) {
                alert(`Failed to delete entries: ${error.message}`);
            }
        }

        // Load and display timeline
        async function loadTimeline() {
            const selectedDate = document.getElementById('timelineDate').value;
            
            try {
                // Fetch both breastfeeding and pumping entries for the selected date
                const [breastfeedingResponse, pumpingResponse] = await Promise.all([
                    fetch(`/api/breastfeeding/entries?date=${selectedDate}`),
                    fetch(`/api/pumping/entries?date=${selectedDate}`)
                ]);

                if (!breastfeedingResponse.ok || !pumpingResponse.ok) {
                    throw new Error('Failed to fetch timeline data');
                }

                const breastfeedingEntries = await breastfeedingResponse.json();
                const pumpingEntries = await pumpingResponse.json();

                // Combine and sort entries by time
                const allTimelineEntries = [
                    ...breastfeedingEntries.map(entry => ({
                        ...entry,
                        type: 'breastfeeding',
                        displayTime: entry.time
                    })),
                    ...pumpingEntries.map(entry => ({
                        ...entry,
                        type: 'pumping',
                        displayTime: entry.time
                    }))
                ].sort((a, b) => a.displayTime.localeCompare(b.displayTime));

                displayTimeline(allTimelineEntries, selectedDate);
            } catch (error) {
                document.getElementById('timelineContainer').innerHTML = `<div class="error">Failed to load timeline: ${error.message}</div>`;
            }
        }

        function displayTimeline(entries, dateStr) {
            const timelineContainer = document.getElementById('timelineContainer');
            
            if (entries.length === 0) {
                timelineContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No entries for this day</p>';
                return;
            }

            // Separate breastfeeding and pumping entries
            const breastfeedingEntries = entries.filter(e => e.type === 'breastfeeding');
            const pumpingEntries = entries.filter(e => e.type === 'pumping');

            // Filter entries for morning (00:00-11:59) and afternoon/evening (12:00-23:59)
            const morningBreastfeeding = breastfeedingEntries.filter(e => {
                const hour = parseInt(e.displayTime.split(':')[0]);
                return hour < 12;
            });
            const afternoonBreastfeeding = breastfeedingEntries.filter(e => {
                const hour = parseInt(e.displayTime.split(':')[0]);
                return hour >= 12;
            });
            const morningPumping = pumpingEntries.filter(e => {
                const hour = parseInt(e.displayTime.split(':')[0]);
                return hour < 12;
            });
            const afternoonPumping = pumpingEntries.filter(e => {
                const hour = parseInt(e.displayTime.split(':')[0]);
                return hour >= 12;
            });

            // Create time slots for the day (split into two 12-hour periods)
            const timelineHTML = `
                <div class="timeline-period">
                    <h3 class="timeline-period-title">Morning (Midnight to Noon)</h3>
                    <div class="timeline-day">
                        <div class="timeline-hours">
                            ${Array.from({length: 12}, (_, i) => `<div class="timeline-hour" data-hour="${i}"><span class="hour-marker">${String(i).padStart(2, '0')}:00</span></div>`).join('')}
                        </div>
                        
                        <div class="timeline-section-label">Breastfeeding & Bottle</div>
                        <div class="timeline-track breastfeeding-track" id="breastfeedingTrackMorning">
                            ${morningBreastfeeding.map((entry) => createBreastfeedingEvent(entry, 0, 12)).join('')}
                        </div>

                        <div class="timeline-section-label">Pumping</div>
                        <div class="timeline-track pumping-track" id="pumpingTrackMorning">
                            ${morningPumping.map((entry) => createPumpingEvent(entry, 0, 12)).join('')}
                        </div>
                    </div>
                </div>

                <div class="timeline-period">
                    <h3 class="timeline-period-title">Afternoon & Evening (Noon to Midnight)</h3>
                    <div class="timeline-day">
                        <div class="timeline-hours">
                            ${Array.from({length: 12}, (_, i) => `<div class="timeline-hour" data-hour="${i+12}"><span class="hour-marker">${String(i+12).padStart(2, '0')}:00</span></div>`).join('')}
                        </div>
                        
                        <div class="timeline-section-label">Breastfeeding & Bottle</div>
                        <div class="timeline-track breastfeeding-track" id="breastfeedingTrackAfternoon">
                            ${afternoonBreastfeeding.map((entry) => createBreastfeedingEvent(entry, 12, 24)).join('')}
                        </div>

                        <div class="timeline-section-label">Pumping</div>
                        <div class="timeline-track pumping-track" id="pumpingTrackAfternoon">
                            ${afternoonPumping.map((entry) => createPumpingEvent(entry, 12, 24)).join('')}
                        </div>
                    </div>
                </div>
            `;

            timelineContainer.innerHTML = timelineHTML;
            
            // Add click handlers for mobile tooltip display
            setupTimelineClickHandlers();
        }

        function setupTimelineClickHandlers() {
            // Remove any existing tooltip
            const existingTooltip = document.querySelector('.timeline-tooltip');
            if (existingTooltip) {
                existingTooltip.remove();
            }

            // Add click handlers to all timeline events
            document.querySelectorAll('.timeline-event').forEach(event => {
                event.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showTimelineTooltip(event);
                });
            });

            // Close tooltip when clicking anywhere else
            document.addEventListener('click', hideTimelineTooltip);
        }

        function showTimelineTooltip(eventElement) {
            // Remove existing tooltip
            hideTimelineTooltip();

            // Get tooltip content from title attribute
            const tooltipText = eventElement.getAttribute('data-tooltip');
            if (!tooltipText) return;

            // Create tooltip element
            const tooltip = document.createElement('div');
            tooltip.className = 'timeline-tooltip';
            tooltip.innerHTML = tooltipText.replace(/\n/g, '<br>');
            document.body.appendChild(tooltip);

            // Position tooltip near the clicked event
            const rect = eventElement.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
            let top = rect.top - tooltipRect.height - 10;

            // Adjust if tooltip goes off screen
            if (left < 10) left = 10;
            if (left + tooltipRect.width > window.innerWidth - 10) {
                left = window.innerWidth - tooltipRect.width - 10;
            }
            if (top < 10) {
                top = rect.bottom + 10; // Show below if no room above
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + window.scrollY + 'px';
            tooltip.classList.add('visible');

            // Mark the event as active
            eventElement.classList.add('tooltip-active');
        }

        function hideTimelineTooltip() {
            const tooltip = document.querySelector('.timeline-tooltip');
            if (tooltip) {
                tooltip.remove();
            }
            document.querySelectorAll('.timeline-event.tooltip-active').forEach(el => {
                el.classList.remove('tooltip-active');
            });
        }

        function createBreastfeedingEvent(entry, startHour = 0, endHour = 24) {
            const time = entry.displayTime.split(':');
            const hour = parseInt(time[0]);
            const minute = parseInt(time[1]);
            const totalMinutes = hour * 60 + minute;
            const rangeMinutes = (endHour - startHour) * 60;
            const minutesFromStart = totalMinutes - (startHour * 60);
            const percentPosition = (minutesFromStart / rangeMinutes) * 100;

            const breastTotal = (entry.leftBreastAmount || 0) + (entry.rightBreastAmount || 0);
            const bottleOnly = breastTotal === 0 && (entry.bottleAmount || 0) > 0;
            const breastOnly = breastTotal > 0 && (entry.bottleAmount || 0) === 0;
            const mixed = breastTotal > 0 && (entry.bottleAmount || 0) > 0;

            let entryClass = 'timeline-event breastfeeding';
            let icon = 'ü§±';
            let label = '';
            let tooltip = '';

            if (bottleOnly) {
                entryClass = 'timeline-event bottle-only';
                icon = 'üçº';
                label = `${entry.bottleAmount}ml`;
                tooltip = `Bottle at ${entry.displayTime}\nBottle: ${entry.bottleAmount}ml`;
            } else if (mixed) {
                entryClass = 'timeline-event breastfeeding mixed';
                label = `${breastTotal}m+${entry.bottleAmount}ml`;
                tooltip = `Mixed feeding at ${entry.displayTime}\nBreast: ${breastTotal}min (L: ${entry.leftBreastAmount}min, R: ${entry.rightBreastAmount}min)\nBottle: ${entry.bottleAmount}ml`;
            } else {
                label = `${breastTotal}m`;
                tooltip = `Breastfeeding at ${entry.displayTime}\nLeft: ${entry.leftBreastAmount}min | Right: ${entry.rightBreastAmount}min`;
            }

            return `
                <div class="${entryClass}" style="left: ${percentPosition}%" data-time="${entry.displayTime}" data-tooltip="${tooltip}" title="${tooltip}">
                    <div class="event-icon">${icon}</div>
                    <div class="event-label">${label}</div>
                </div>
            `;
        }

        function createPumpingEvent(entry, startHour = 0, endHour = 24) {
            const time = entry.displayTime.split(':');
            const hour = parseInt(time[0]);
            const minute = parseInt(time[1]);
            const totalMinutes = hour * 60 + minute;
            const rangeMinutes = (endHour - startHour) * 60;
            const minutesFromStart = totalMinutes - (startHour * 60);
            const percentPosition = (minutesFromStart / rangeMinutes) * 100;

            const icon = entry.isPowerPump ? '‚ö°' : 'üîÑ';
            const label = `${entry.amount}ml`;
            const tooltip = `Pumping at ${entry.displayTime}\nAmount: ${entry.amount}ml${entry.isPowerPump ? '\n(Power Pump)' : ''}`;

            return `
                <div class="timeline-event pumping" style="left: ${percentPosition}%" data-time="${entry.displayTime}" data-tooltip="${tooltip}" title="${tooltip}">
                    <div class="event-icon">${icon}</div>
                    <div class="event-label">${label}</div>
                </div>
            `;
        }
    </script>
    <script src="../js/nav.js"></script>
</body>
</html>
